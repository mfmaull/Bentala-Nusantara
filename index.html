<!DOCTYPE html>
<html lang="id" class="scroll-smooth" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bentala Nusantara | WebGIS Minimalist ‚Äî Modern</title>

  <!-- Tailwind (utility) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- MapLibre (kept as original) -->
  <link href="https://unpkg.com/maplibre-gl@^5.7.3/dist/maplibre-gl.css" rel="stylesheet" />
  <script defer src="https://unpkg.com/maplibre-gl@^5.7.3/dist/maplibre-gl.js"></script>

  <!-- Turf (geoprocessing lib) -->
  <script defer src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

  <!-- AOS for animations -->
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet" />
  <script defer src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet" />

  <meta name="description" content="Bentala Nusantara ‚Äî WebGIS minimalis, modern, dan compact.">

  <style>
    /* ======================
       Palette & variables
       default: light theme
       ====================== */
    :root{
      --bg: #ffffff;
      --fg: #0b0b0b;
      --krem: #f3ead7;
      --muted: #6f6f6f;
      --card: #fbf9f6;
      --border: #ece7df;
      --glass: rgba(11,11,11,0.04);
      --accent: #0b0b0b;
      --radius: 12px;
      --shadow-soft: 0 8px 20px rgba(11,11,11,0.06);
      --smooth: 300ms;
    }

    [data-theme="dark"]{
      /* full inversion palette for dark mode */
      --bg: #0a0a0a;
      --fg: #f5f5f5;
      --krem: #322b23; /* muted krem tone for dark */
      --muted: #bdbdbd;
      --card: #141414;
      --border: #222;
      --glass: rgba(255,255,255,0.03);
      --accent: #f5f5f5;
      --shadow-soft: 0 10px 30px rgba(0,0,0,0.6);
    }

    /* Base */
    html,body{height:100%; margin:0; font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:var(--bg); color:var(--fg); -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;}
    a{color:inherit; text-decoration:none}
    .container{max-width:1200px; margin-left:auto; margin-right:auto; padding-left:1rem; padding-right:1rem}

    /* Header */
    header{
      position:sticky; top:0; z-index:60;
      background:linear-gradient(180deg, rgba(255,255,255,0.65), rgba(255,255,255,0.45));
      border-bottom:1px solid var(--border);
      backdrop-filter: blur(6px);
      transition: background var(--smooth), border-color var(--smooth);
    }
    [data-theme="dark"] header{
      background:linear-gradient(180deg, rgba(10,10,10,0.8), rgba(10,10,10,0.7));
    }
    header .logo { display:flex; gap:.6rem; align-items:center }
    header .logo .mark{ width:44px; height:44px; border-radius:10px; display:flex; align-items:center; justify-content:center; border:1px solid var(--border); background:linear-gradient(180deg,var(--card), #fff); box-shadow:var(--shadow-soft) }
    header .title{ font-weight:700; font-size:1rem }
    header .subtitle{ font-size:.75rem; color:var(--muted) }

    /* Buttons */
    .btn-primary{ background:var(--accent); color:var(--bg); padding:.5rem .9rem; border-radius:999px; font-weight:600; display:inline-flex; gap:.5rem; align-items:center; box-shadow: 0 6px 18px rgba(11,11,11,0.06); transition: transform .18s ease, box-shadow .18s ease; border:1px solid rgba(0,0,0,0.04) }
    .btn-primary:hover{ transform:translateY(-3px) }
    .btn-outline{ background:transparent; color:var(--fg); padding:.46rem .8rem; border-radius:999px; border:1px solid var(--border); font-weight:600 }

    /* Glass card */
    .glass{ background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow-soft); transition: transform var(--smooth), box-shadow var(--smooth), border-color var(--smooth) }
    .glass:hover{ transform: translateY(-6px); box-shadow: 0 14px 40px rgba(11,11,11,0.08) }

    /* Utility */
    .muted{ color:var(--muted) }
    .small-input{ padding:.6rem .8rem; border-radius:.5rem; border:1px solid var(--border); background:transparent; color:var(--fg); width:100% }
    .small-input:focus{ outline:none; box-shadow:0 6px 18px rgba(0,0,0,0.06) }

    /* Layout: Hero */
    .hero{ padding:3.5rem 0 2rem 0; text-align:center }
    .hero h1{ font-size:2.2rem; margin:0; line-height:1.05; font-weight:800 }
    .hero p{ margin-top:.6rem; color:var(--muted) }

    /* Explore grid */
    .explore-grid{ display:grid; grid-template-columns:repeat(3,1fr); gap:1rem }
    .explore-item{ padding:1.1rem; border-radius:10px }

    /* Map container */
    #map-container{ width:100%; max-width:1200px; margin:0 auto }
    #map{ width:100%; height:720px; border-radius:14px; overflow:hidden; border:1px solid var(--border) }

    /* Portfolio scroller -> desktop & mobile */
    .portfolio-row{ display:flex; gap:1rem; overflow-x:auto; padding-bottom:.5rem; -webkit-overflow-scrolling:touch }
    .portfolio-card{ min-width:300px; max-width:420px; flex:0 0 auto; border-radius:12px; overflow:hidden }

    .portfolio-card img{ width:100%; height:176px; object-fit:cover; display:block; }

    /* Comments */
    #comment-list .comment { padding:.8rem; border-radius:8px; border:1px solid var(--border); background:var(--card) }
    .pagination button{ padding:.35rem .6rem; border-radius:6px; border:1px solid var(--border) }

    /* Bottom nav (mobile) */
    .bottom-nav{
      position:fixed; left:0; right:0; bottom:12px; z-index:80;
      display:flex; justify-content:center;
    }
    .bottom-nav-inner{
      display:flex; gap:8px; background:var(--card); border-radius:30px; padding:8px; border:1px solid var(--border); box-shadow:0 10px 30px rgba(0,0,0,0.08);
    }
    .bottom-item{ display:flex; flex-direction:column; align-items:center; justify-content:center; padding:.45rem .6rem; border-radius:10px; font-size:.85rem; color:var(--muted) }
    .bottom-item.active{ color:var(--accent); font-weight:700 }

    /* Responsive / Mobile-first compact (aggressive) */
    @media (max-width: 768px){
      .hero{ padding:1.6rem 0; }
      .hero h1{ font-size:1.4rem }
      .explore-grid{ grid-template-columns:1fr; gap:.8rem }
      #map{ height:320px; border-radius:12px }
      .portfolio-row{ display:grid; grid-template-columns:1fr; gap:.8rem; overflow:visible }
      header .nav{ display:none }
      .container{ padding-left:.75rem; padding-right:.75rem }
      .bottom-nav{ display:block }
      .glass:hover{ transform:none; box-shadow:var(--shadow-soft) }
    }

    /* Prefer reduced motion */
    @media (prefers-reduced-motion: reduce){
      *{ transition:none !important; animation:none !important }
    }

    /* subtle entrance animations (CSS) */
    .fade-up{ transform: translateY(8px); opacity:0; transition: transform .55s cubic-bezier(.2,.9,.2,1), opacity .55s; }
    .fade-up.in{ transform:none; opacity:1; }

    /* tiny helpers */
    .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }
  </style>
</head>

<body>
  <!-- HEADER -->
  <header>
    <div class="container flex items-center justify-between py-3">
      <div class="logo">
        <div class="mark" aria-hidden="true">üìç</div>
        <div>
          <div class="title">Bentala Nusantara</div>
          <div class="subtitle muted">WebGIS ‚Ä¢ Minimalist ‚Ä¢ Modern</div>
        </div>
      </div>

      <nav class="nav hidden md:flex items-center gap-6">
        <a href="#home" class="muted">Beranda</a>
        <a href="#map-canvas" class="muted">My Map</a>
        <a href="#portfolio" class="muted">Portfolio</a>
      </nav>

      <div class="flex items-center gap-3">
        <button id="theme-toggle" class="glass px-3 py-1 text-sm" title="Toggle theme">Dark</button>
        <a href="map.html" class="btn-primary">üî• Mulai Ekspedisi</a>
      </div>
    </div>
  </header>

  <!-- HERO -->
  <section id="home" class="hero container" data-aos="fade-up">
    <h1>Eksplorasi Nusantara</h1>
    <p class="muted">Temukan data geospasial terkini dengan peta interaktif masa kini</p>

    <div class="mt-4 flex justify-center gap-3 hero-actions">
      <a href="#map-canvas" id="btn-scroll-map" class="btn-primary">üåé Lihat Peta</a>
      <a href="#portfolio" class="btn-outline">üìÅ Portfolio</a>
    </div>
  </section>

  <!-- EXPLORE CARDS -->
  <section class="container mb-6" aria-hidden="false">
    <div class="explore-grid" data-aos="fade-up" data-aos-delay="120">
      <div class="glass explore-item">
        <div class="flex items-center gap-3 mb-3">
          <div class="w-10 h-10 rounded-full flex items-center justify-center" style="background:var(--krem)">üó∫Ô∏è</div>
          <div class="font-semibold">Pemetaan Interaktif</div>
        </div>
        <p class="muted text-sm">Layer, popup, marker, dan integrasi data real-time.</p>
      </div>

      <div class="glass explore-item">
        <div class="flex items-center gap-3 mb-3">
          <div class="w-10 h-10 rounded-full flex items-center justify-center" style="background:var(--krem)">üìö</div>
          <div class="font-semibold">Database Geospasial</div>
        </div>
        <p class="muted text-sm">GeoJSON / PostGIS-ready untuk analisis & visualisasi.</p>
      </div>

      <div class="glass explore-item">
        <div class="flex items-center gap-3 mb-3">
          <div class="w-10 h-10 rounded-full flex items-center justify-center" style="background:var(--krem)">‚öôÔ∏è</div>
          <div class="font-semibold">Geoprocessing Online</div>
        </div>
        <p class="muted text-sm">Buffering, clipping, hotspot analysis via Turf.js.</p>
      </div>
    </div>
  </section>

  <!-- MAP PREVIEW -->
  <section id="map-canvas" class="py-6">
    <div class="container text-center mb-4" data-aos="fade-up">
      <h3 class="text-lg font-semibold">üó∫Ô∏è My Map (Preview)</h3>
      <p class="muted">Preview peta sederhana. Klik "Mulai Ekspedisi" untuk peta penuh.</p>
    </div>

    <div class="container" id="map-container">
      <div id="map" class="glass" role="region" aria-label="Peta preview"></div>
      <div id="map-fallback" class="hidden text-center muted mt-4">üó∫Ô∏è Peta tidak dapat dimuat. Periksa koneksi atau API key.</div>
    </div>
  </section>

  <!-- PORTFOLIO -->
  <section id="portfolio" class="py-8 border-t">
    <div class="container text-center mb-4" data-aos="fade-up">
      <h3 class="text-xl font-semibold">Portfolio</h3>
      <p class="muted">Proyek & visualisasi geospasial oleh Bentala Nusantara</p>
    </div>

    <div class="container portfolio-row" data-aos="fade-up" data-aos-delay="120" id="portfolio-list">
      <article class="portfolio-card glass p-4">
        <img loading="lazy" decoding="async" src="./assets/portfolio/New CineMAX.png" alt="New CineMAX" />
        <div class="mt-3">
          <div class="font-semibold">Location Analytics for New CineMAX</div>
          <div class="muted text-sm mb-2">Rekomendasi lokasi berdasarkan analisis mobilitas & kepadatan.</div>
          <a href="./assets/portfolio/New CineMAX.pdf" target="_blank" class="btn-outline inline-block">Detail (PDF)</a>
        </div>
      </article>

      <article class="portfolio-card glass p-4">
        <img loading="lazy" decoding="async" src="./assets/portfolio/Shelter Evakuasi Gempa.png" alt="Shelter Evakuasi Gempa" />
        <div class="mt-3">
          <div class="font-semibold">Evacuation Shelter Earthquake Analysis</div>
          <div class="muted text-sm mb-2">Analisis zona aman & rute evakuasi.</div>
          <a href="./assets/portfolio/Shelter Evakuasi Gempa.pdf" target="_blank" class="btn-outline inline-block">Detail (PDF)</a>
        </div>
      </article>

      <article class="portfolio-card glass p-4">
        <img loading="lazy" decoding="async" src="./assets/portfolio/Wonogiri Hyperlocal Analysis.png" alt="Wonogiri Hyperlocal Analysis" />
        <div class="mt-3">
          <div class="font-semibold">Hyperlocal Analysis for Trans Surakarta</div>
          <div class="muted text-sm mb-2">Analisis halte/terminal potensial menggunakan data hyperlocal.</div>
          <a href="./assets/portfolio/Wonogiri Hyperlocal Analysis.pdf" target="_blank" class="btn-outline inline-block">Detail (PDF)</a>
        </div>
      </article>
    </div>
  </section>

  <!-- COMMENTS -->
  <section id="comments" class="py-8">
    <div class="container max-w-3xl mx-auto" data-aos="fade-up">
      <h3 class="text-lg font-semibold text-center mb-3">üí¨ Komentar Pengguna</h3>

      <div class="glass p-4">
        <form id="comment-form" class="flex flex-col gap-3">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
            <input id="comment-name" class="small-input" placeholder="Nama (opsional)" />
            <input id="comment-email" class="small-input" placeholder="Email (opsional)" />
          </div>

          <textarea id="comment-input" class="small-input" rows="3" placeholder="Tulis komentar..." required></textarea>

          <div class="flex items-center gap-3">
            <button type="submit" class="btn-primary">Kirim</button>

            <div class="ml-auto flex items-center gap-2 text-sm muted">
              <label for="rows-per-page">Rows</label>
              <select id="rows-per-page" class="small-input">
                <option value="5">5</option>
                <option value="10">10</option>
                <option value="15">15</option>
              </select>
            </div>
          </div>
        </form>

        <div id="comment-list" class="mt-4 space-y-3"></div>
        <div id="pagination-controls" class="mt-3 flex items-center justify-center gap-2 pagination"></div>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="py-6 text-center muted border-t">¬© 2025 Bentala Nusantara</footer>

  <!-- Bottom navigation for mobile -->
  <nav class="bottom-nav" aria-hidden="false">
    <div class="bottom-nav-inner">
      <a href="#home" class="bottom-item" id="bn-home"><span>üè†</span><small>Home</small></a>
      <a href="#map-canvas" class="bottom-item" id="bn-map"><span>üó∫Ô∏è</span><small>Map</small></a>
      <a href="#portfolio" class="bottom-item" id="bn-portfolio"><span>üìÅ</span><small>Portfolio</small></a>
      <a href="#comments" class="bottom-item" id="bn-comments"><span>üí¨</span><small>Comments</small></a>
    </div>
  </nav>

  <!-- Scripts (deferred) -->
  <script>
    // Respect reduced motion
    const prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;

    // AOS init (deferred loaded)
    window.addEventListener('load', () => {
      if (window.AOS && !prefersReduced) AOS.init({ duration: 650, once: true, offset: 60 });
      else if (window.AOS) AOS.init({ duration: 0, once: true, offset: 0 });
    });

    /* -----------------------------
       Theme toggle with persistence
       ----------------------------- */
    const themeToggle = document.getElementById('theme-toggle');
    const htmlEl = document.documentElement;
    function setTheme(t) {
      htmlEl.setAttribute('data-theme', t);
      themeToggle.textContent = t === 'dark' ? 'Light' : 'Dark';
      try { localStorage.setItem('bn_theme', t); } catch (e) { /* ignore */ }
    }
    (function initTheme() {
      try {
        const stored = localStorage.getItem('bn_theme');
        if (stored) setTheme(stored);
        else {
          const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
          setTheme(prefersDark ? 'dark' : 'light');
        }
      } catch (e) { setTheme('light'); }
    })();
    themeToggle.addEventListener('click', () => setTheme(htmlEl.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'));

    /* -----------------------------
       Smooth anchor scrolling
       ----------------------------- */
    document.querySelectorAll('a[href^="#"]').forEach(a => {
      a.addEventListener('click', (e) => {
        const target = a.getAttribute('href');
        if (target && target.startsWith('#')) {
          const el = document.querySelector(target);
          if (el) { e.preventDefault(); el.scrollIntoView({ behavior: 'smooth', block: 'start' }); }
        }
      });
    });

    /* ==============================
       Map lazy-init (IntersectionObserver)
       ============================== */
    const MAP_SERVICE_KEY = "68da7e8806823ed3f510cc50";
    const DEFAULT_THEME = "basic";
    let mapInstance = null;
    let mapInitialized = false;

    function createMap() {
      if (mapInitialized || typeof maplibregl === 'undefined') return;
      mapInitialized = true;

      // LocalStorage test (some policies)
      try { localStorage.setItem('bn_test','1'); localStorage.removeItem('bn_test'); } catch(e){ window.__localBlocked = true; }

      mapInstance = new maplibregl.Map({
        container: 'map',
        style: `https://basemap.mapid.io/styles/${DEFAULT_THEME}/style.json?key=${MAP_SERVICE_KEY}`,
        center: [106.82717425766694, -6.175403054116954],
        zoom: 12,
        pitch: 0,
        bearing: 0,
        canvasContextAttributes: { antialias: true },
        attributionControl: true,
      });

      mapInstance.on('load', function () {
        // Fit bounds as in original
        const bounds = [[106.60, -6.05], [107.05, -6.30]];
        try { mapInstance.fitBounds(bounds, { padding: 8, maxZoom: 12 }); } catch(e){}
      });

      mapInstance.addControl(new maplibregl.NavigationControl(), 'top-right');

      // expose
      window.BN_MAP = mapInstance;
    }

    // Observe map element for entering viewport
    const mapEl = document.getElementById('map');
    if ('IntersectionObserver' in window) {
      const io = new IntersectionObserver((entries, obs) => {
        entries.forEach(ent => {
          if (ent.isIntersecting) {
            createMap();
            obs.unobserve(ent.target);
          }
        });
      }, { rootMargin: '200px' });
      io.observe(mapEl);
    } else {
      // fallback: init on load
      window.addEventListener('load', createMap);
    }

    // Also init map when user clicks Lihat Peta
    document.getElementById('btn-scroll-map').addEventListener('click', () => {
      createMap();
    });

    /* ==============================
       Comments (API-backed) keeping original functionality
       ============================== */
    const API_ENDPOINT = "https://68d145ade6c0cbeb39a42e48.mockapi.io/webgis/saran/v1/";
    const commentForm = document.getElementById('comment-form');
    const commentInput = document.getElementById('comment-input');
    const nameInput = document.getElementById('comment-name');
    const emailInput = document.getElementById('comment-email');
    const rowsPerPageSelect = document.getElementById('rows-per-page');
    const commentList = document.getElementById('comment-list');
    const paginationControls = document.getElementById('pagination-controls');

    let allComments = [];
    let currentPage = 1;
    let rowsPerPage = parseInt(rowsPerPageSelect.value || 5);

    rowsPerPageSelect.addEventListener('change', () => { rowsPerPage = parseInt(rowsPerPageSelect.value); currentPage = 1; renderComments(); });

    function escapeHtml(unsafe) {
      if (!unsafe && unsafe !== 0) return '';
      return String(unsafe).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#039;');
    }

    async function fetchComments() {
      try {
        const res = await fetch(API_ENDPOINT + "?sortBy=id&order=desc");
        if (!res.ok) throw new Error('Network response not ok: ' + res.status);
        const data = await res.json();
        allComments = data;
        renderComments();
      } catch (err) {
        console.error('Fetch comments failed:', err);
        commentList.innerHTML = `<div class="text-center text-red-500 p-4">Gagal memuat komentar.</div>`;
      }
    }

    function renderComments() {
      const total = allComments.length;
      const totalPages = Math.max(1, Math.ceil(total / rowsPerPage));
      if (currentPage > totalPages) currentPage = totalPages;
      const start = (currentPage - 1) * rowsPerPage;
      const pageData = allComments.slice(start, start + rowsPerPage);

      commentList.innerHTML = '';
      if (!pageData.length) {
        commentList.innerHTML = `<div class="text-center muted p-4">Belum ada komentar.</div>`;
      } else {
        pageData.forEach(c => {
          const div = document.createElement('div');
          div.className = 'comment';
          const name = c.name || 'Pengunjung';
          const text = c.kritik_saran || c.text || '';
          const ts = c.createdAt ? new Date(c.createdAt).toLocaleString() : (c.timestamp || '');
          div.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div style="font-weight:600">üë§ ${escapeHtml(name)}</div><div style="font-size:.8rem;color:var(--muted)">${escapeHtml(ts)}</div></div><div style="margin-top:.5rem">${escapeHtml(text)}</div>`;
          commentList.appendChild(div);
        });
      }
      renderPaginationControls(totalPages);
    }

    function renderPaginationControls(totalPages) {
      paginationControls.innerHTML = '';
      const prev = document.createElement('button'); prev.textContent = '‚Äπ'; prev.className = 'px-2 py-1 rounded border'; prev.disabled = currentPage===1;
      prev.onclick = () => { if (currentPage>1){ currentPage--; renderComments(); } };
      paginationControls.appendChild(prev);

      const startPage = Math.max(1, currentPage - 2);
      const endPage = Math.min(totalPages, startPage + 4);
      for (let p = startPage; p <= endPage; p++){
        const btn = document.createElement('button');
        btn.textContent = p;
        btn.className = `px-3 py-1 rounded ${p===currentPage ? 'bg-[var(--accent)] text-[var(--bg)] font-semibold' : 'hover:bg-[var(--border)]'}`;
        btn.onclick = () => { currentPage = p; renderComments(); };
        paginationControls.appendChild(btn);
      }

      const next = document.createElement('button'); next.textContent = '‚Ä∫'; next.className = 'px-2 py-1 rounded border'; next.disabled = currentPage===totalPages;
      next.onclick = () => { if (currentPage<totalPages){ currentPage++; renderComments(); } };
      paginationControls.appendChild(next);
    }

    commentForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = commentInput.value.trim();
      if (!text) return alert('Komentar tidak boleh kosong.');
      const payload = { name: (nameInput.value.trim() || 'Pengunjung'), email: (emailInput.value.trim() || ''), kritik_saran: text };
      const optimistic = { ...payload, createdAt: new Date().toISOString() };
      allComments.unshift(optimistic);
      renderComments();
      commentInput.value = ''; nameInput.value = ''; emailInput.value = '';

      try {
        const resp = await fetch(API_ENDPOINT, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        if (!resp.ok) { console.error('POST failed', resp.status); alert('Gagal mengirim komentar ke server. Ditampilkan lokal.'); fetchComments(); }
        else { fetchComments(); }
      } catch (err) {
        console.error('Post error', err); alert('Gagal mengirim komentar. Periksa koneksi.'); fetchComments();
      }
    });

    // initial load
    fetchComments();

    /* ==============================
       Mobile bottom nav active state
       ============================== */
    function setBottomActive(hash){
      document.querySelectorAll('.bottom-item').forEach(el => el.classList.remove('active'));
      const map = { '#home':'bn-home', '#map-canvas':'bn-map', '#portfolio':'bn-portfolio', '#comments':'bn-comments' }[hash];
      if(map){
        const el = document.getElementById(map);
        if(el) el.classList.add('active');
      }
    }

    // set on scroll (simple)
    window.addEventListener('scroll', () => {
      const sections = ['#home','#map-canvas','#portfolio','#comments'];
      let current = '#home';
      for(const s of sections){
        const el = document.querySelector(s);
        if(!el) continue;
        const rect = el.getBoundingClientRect();
        if(rect.top <= window.innerHeight * 0.4) current = s;
      }
      setBottomActive(current);
    });

    // enable keyboard focus for accessibility for bottom nav links
    document.querySelectorAll('.bottom-item').forEach(it => {
      it.addEventListener('click', (e) => { /* smooth handled by anchor */ });
    });

    /* ==============================
       Lazy enhancement: lazy-load portfolio images when near viewport
       ============================== */
    if ('IntersectionObserver' in window) {
      const imgs = document.querySelectorAll('img[loading="lazy"]');
      const obsImg = new IntersectionObserver((entries, o) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            const img = entry.target;
            // ensure src already set (we used src directly), but for heavy sites you'd set data-src
            img.classList.add('in'); // small visual hook
            o.unobserve(img);
          }
        });
      }, { rootMargin: '200px' });
      imgs.forEach(i => obsImg.observe(i));
    }

    /* ==============================
       Small perf hint: remove AOS listeners if user prefers reduced motion
       ============================== */
    if (prefersReduced && window.AOS) {
      try { window.removeEventListener('scroll', AOS.refresh); } catch(e){}
    }

    // soft fade-up on elements (CSS fallback) for non-AOS environments
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('[data-aos]').forEach(el => {
        el.classList.add('fade-up');
        setTimeout(()=>el.classList.add('in'), 90);
      });
    });
  </script>
</body>
</html>
